# TCP サーバー

## プログラムコード

以下のコードをtcpServer.php に書き込んでください。

```php
// サーバーオブジェクトを作成し、127.0.0.1:9501 ポートをリッスンする。
$server = new Swoole\Server('127.0.0.1', 9501);

// 接続イベントをリッスン。
$server->on('Connect', function ($server, $fd) {
    echo "Client: Connect.\n";
});

// データ受信イベントをリッスン。
$server->on('Receive', function ($server, $fd, $reactor_id, $data) {
    $server->send($fd, "Server: {$data}");
});

// 接続クローズイベントをリッスン。
$server->on('Close', function ($server, $fd) {
    echo "Client: Close.\n";
});

// サーバーを起動
$server->start();
```

これにより、本機の9501ポートをリッスンする`TCP`サーバーが作成されます。このサーバーのロジックは非常にシンプルで、クライアントが `hello` 文字列をネットワーク経由で送信すると、サーバーは `Server: hello` 文字列を返信します。

`Server`は非同期サーバーであり、プログラムはイベントをリッスンする方法で記述されています。対応するイベントが発生すると、下層では指定された関数が自動的にコールバックされます。たとえば、新しい`TCP`接続が入ると、[onConnect](/server/events?id=onconnect)イベントコールバックが実行され、ある接続がサーバーにデータを送信すると、[onReceive](/server/events?id=onreceive)関数がコールバックされます。

* サーバーは成千上万のクライアント接続と同時に接続できますが、 `$fd` はクライアント接続の一意な識別子です。
* `$server->send()` メソッドを呼び出して、クライアント接続にデータを送信できます。引数は `$fd` クライアント識別子です。
* `$server->close()` メソッドを使用して特定のクライアント接続を強制的に閉じることができます。
* クライアントは自発的に接続を切断する可能性があり、その際は[onClose](/server/events?id=onclose)イベントコールバックがトリガーされます。

## プログラムの実行

```shell
php tcpServer.php
```

コマンドラインで `server.php` プログラムを実行し、正常に起動すると `netstat` ツールを使用して、すでに9501ポートをリスニングしていることが確認できます。

この状態で `telnet/netcat` ツールを使用してサーバーに接続できます。

```shell
telnet 127.0.0.1 9501
hello
Server: hello
```

## サーバーへの接続ができない場合の簡単なチェック手段

* `Linux` では、`netstat -an | grep ポート` を使用して、ポートが`Listening`状態になっているかどうかを確認します。
* 前の手順が確認されたら、ファイアウォールの問題を再確認してください。
* サーバーが使用しているIPアドレスに注意してください。`127.0.0.1` ループバックアドレスを使用している場合、クライアントは `127.0.0.1` のみを使用して接続する必要があります。
* Alibaba Cloud や Tencent Cloud を使用している場合は、セキュリティグループで使用するポートを設定する必要があります。

## TCPデータパケットの境界問題。

[TCPデータパケットの境界問題](/learn?id=tcpデータパケットの境界問題) を参照してください。
